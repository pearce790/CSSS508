<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>CSSS 508, Lecture 2</title>
    <meta charset="utf-8" />
    <meta name="author" content="Michael Pearce (based on slides from Chuck Lanfear)" />
    <meta name="date" content="2022-10-06" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, top, title-slide

.title[
# CSSS 508, Lecture 2
]
.subtitle[
## Visualizing Data
]
.author[
### Michael Pearce<br>(based on slides from Chuck Lanfear)
]
.date[
### October 6, 2022
]

---




class: inverse

# But First...
## *Some useful coding tips*

---

# Comments

You may have noticed that sometimes I write code that looks like this:

```r
new.object &lt;- 1:10 # Making vector of 1 to 10 
```
`#` is known as the *commenting symbol* in R!

Anything written *after* `#` will not be run by R.

This is useful for annotating your code to remind others (and you!) how your code works.&lt;sup&gt;1&lt;/sup&gt;

.footnote[
[1] In R Markdown documents, comments only work in chunks. Outside of a chunk, `#` creates **headers** like "comments" at the top of this slide.
]

---

# Saving Data

You can save an R object on your computer as a file to open later:

```r
save(new.object, file="new_object.RData")
```

--

You can open saved files in R as well:

```r
load("new_object.RData")
```

--

But where are these files being saved and loaded from?

---

# Working Directories

R saves files and looks for files to open in your current **working directory**. You
can ask R what this is:



```r
getwd()
```

```
## [1] "/Users/pearce790/CSSS508/Lectures/Lecture 2"
```

--

Similarly, we can set a working directory like so:


```r
setwd("C:/Users/pearce790/CSSS508/HW2")
```

--

*Don't set a working directory in R Markdown documents!* They automatically set the directory they are in as the working directory.

---

# Managing Files

When managing R projects, it is normally best to give each project (such as a homework
assignment) its own folder. I use the following system:

--

* Every class or project has its own folder
--

* Each assignment or task has a folder inside that, which is the working directory for that item.
--

* `.Rmd` and `.R` files are named clearly and completely

--

For example, this presentation is located and named this:
`GitHub/CSSS508/Lectures/Lecture2/CSSS508_Lecture2_ggplot2.Rmd`

--

You can use whatever system you want, but be consistent so your projects are organized! 
You don't want to lose work by losing or overwriting files!


---

# File Types

We mainly work with four file types in this class:

--

* `.Rmd`: These are **markdown** *syntax* files, where you write code to *make documents*.

--

* `.R`: These are **R** *syntax* files, where you write code to process and analyze data *without making an output document*.

--

* `.html` or `.pdf`: These are the output documents created when you *knit* a markdown document.

--

Make sure you understand the difference between the uses of these file types!

---
class: inverse

# Data

---

# Gapminder Data

We'll be working with data from Hans Rosling's [Gapminder](http://www.gapminder.org) project.
An excerpt of these data can be accessed through an R package called `gapminder`, cleaned and assembled by Jenny Bryan at UBC.

--

In the console: `install.packages("gapminder")`

Load the package and data:

```r
library(gapminder)
```

---

# Check Out Gapminder

The data frame we will work with is called `gapminder`, available once you have loaded the package. Let's see its structure:

.small[

```r
str(gapminder)
```

```
## tibble [1,704 × 6] (S3: tbl_df/tbl/data.frame)
##  $ country  : Factor w/ 142 levels "Afghanistan",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ continent: Factor w/ 5 levels "Africa","Americas",..: 3 3 3 3 3 3 3 3 3 3 ...
##  $ year     : int [1:1704] 1952 1957 1962 1967 1972 1977 1982 1987 1992 1997 ...
##  $ lifeExp  : num [1:1704] 28.8 30.3 32 34 36.1 ...
##  $ pop      : int [1:1704] 8425333 9240934 10267083 11537966 13079460 14880372 12881816 13867957 16317921 22227415 ...
##  $ gdpPercap: num [1:1704] 779 821 853 836 740 ...
```
]

---

# What's Interesting Here?

* **Factor** variables `country` and `continent`

   + Factors are categorical data with an underlying numeric representation
   + We'll spend a lot of time on factors later!

--

* Many observations: `\(n=1704\)` rows

--

* For each observation, a few variables: `\(p=6\)` columns

--

* A nested/hierarchical structure: `year` in `country` in `continent`

   + These are panel data!

---
class: inverse

# Subsetting Data


---

# Installing Tidyverse

We'll want to be able to slice up this data frame into subsets (e.g. just the rows for Afghanistan, just the rows for 1997).

We will use a package called `dplyr` to do this neatly.

`dplyr` is part of the [tidyverse](http://tidyverse.org/) family of R packages that are the focus of this course.

--

If you have not already installed the tidyverse, type, in the console: `install.packages("tidyverse")`

--

This will install a *large* number of R packages we will use throughout the term, including `dplyr`.

`dplyr` is a very useful and powerful package that we will talk more about soon, but today we're just going to use it for "filtering" data.

---

# Loading dplyr


```r
library(dplyr)
```

```
## 
## Attaching package: 'dplyr'
```

```
## The following objects are masked from 'package:stats':
## 
##     filter, lag
```

```
## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union
```

---

# Wait, was that an error?

When you load packages in R that have functions sharing the same name as functions you already have, the more recently loaded functions overwrite the previous ones ("masks them").

--

This **message** is just letting you know that. To avoid showing this in your R Markdown file, add `message=FALSE` or `include=FALSE` to your chunk options when loading packages.

--

Sometimes you may get a **warning message** when loading packages---usually because you aren't running the latest version of R:

```
Warning message:
package `gapminder' was built under R version 3.5.3 
```
Chunk options `message=FALSE` or `include=FALSE` will hide this. *Update R* to deal with it completely!

---

# Pipes

`dplyr` allows us to use the "pipe" data between functions using the (`%&gt;%`) operator. So instead of nesting functions like this:



```r
log(mean(gapminder$pop))
```

```
## [1] 17.20333
```

--

We can pipe them like this:


```r
gapminder$pop %&gt;% mean() %&gt;% log()
```

```
## [1] 17.20333
```

--

Read this as, "send `gapminder$pop` to `mean()`, then send the output of that to `log()`."
In essence, pipes read "left to right" while nested functions read "inside to out."
This may be confusing... we'll cover it more later!

---

# `filter` Data Frames


```r
gapminder %&gt;% filter(country == "Algeria")
```

```
## # A tibble: 12 × 6
##    country continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Algeria Africa     1952    43.1  9279525     2449.
##  2 Algeria Africa     1957    45.7 10270856     3014.
##  3 Algeria Africa     1962    48.3 11000948     2551.
##  4 Algeria Africa     1967    51.4 12760499     3247.
##  5 Algeria Africa     1972    54.5 14760787     4183.
##  6 Algeria Africa     1977    58.0 17152804     4910.
##  7 Algeria Africa     1982    61.4 20033753     5745.
##  8 Algeria Africa     1987    65.8 23254956     5681.
##  9 Algeria Africa     1992    67.7 26298373     5023.
## 10 Algeria Africa     1997    69.2 29072015     4797.
## 11 Algeria Africa     2002    71.0 31287142     5288.
## 12 Algeria Africa     2007    72.3 33333216     6223.
```

What is this doing?

---

# How Expressions Work

What does `country == "Algeria"` actually do? 

--


```r
head(gapminder$country == "Algeria", 50) # display first 50 elements
```

```
##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [12] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [23] FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
## [34]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [45] FALSE FALSE FALSE FALSE FALSE FALSE
```


It returns a vector of `TRUE` or `FALSE` values.

--

**Check your understanding:** How are `==`, `=` and `&lt;-` the same or different?

---

# Logical Operators

We used `==` for testing "equals": `country == "Algeria"`.

--

There are many other [logical operators](http://www.statmethods.net/management/operators.html):

--

* `!=`: not equal to
--

* `&gt;`, `&gt;=`, `&lt;`, `&lt;=`: less than, less than or equal to, etc.
--

* `%in%`: used with checking equal to one of several values

--

Or we can combine multiple logical conditions:

* `&amp;`: both conditions need to hold (AND)
--

* `|`: at least one condition needs to hold (OR)
--

* `!`: inverts a logical condition (`TRUE` becomes `FALSE`, `FALSE` becomes `TRUE`)

--

We'll use these a lot so don't worry too much right now!

---

# Multiple Conditions Example



```r
gapminder %&gt;%
    filter(country == "Oman" &amp; year &gt; 1980)
```

```
## # A tibble: 6 × 6
##   country continent  year lifeExp     pop gdpPercap
##   &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;     &lt;dbl&gt;
## 1 Oman    Asia       1982    62.7 1301048    12955.
## 2 Oman    Asia       1987    67.7 1593882    18115.
## 3 Oman    Asia       1992    71.2 1915208    18617.
## 4 Oman    Asia       1997    72.5 2283635    19702.
## 5 Oman    Asia       2002    74.2 2713462    19775.
## 6 Oman    Asia       2007    75.6 3204897    22316.
```

---
# Multiple Conditions

.pull-left[

### And: `&amp;`


```r
gapminder %&gt;% 
  filter(country == "Oman" &amp;
         year &gt; 1980)
```

.image-100[
![](img/country_and_year.svg)
]

*Give me rows where the country is Oman **and** the year is after 1980.*

]

--

.pull-right[

### Or: `|`


```r
gapminder %&gt;%
  filter(country == "Oman" |
         year &gt; 1980)
```

.image-100[
![](img/country_or_year.svg)
]

*Give me rows where the country is Oman **or** the year is after 1980... or **both**.*

]

---

# Saving a Subset

If we think a particular subset will be used repeatedly, we can save it and give it a name like any other object:


```r
China &lt;- gapminder %&gt;% filter(country == "China")
head(China, 4)
```

```
## # A tibble: 4 × 6
##   country continent  year lifeExp       pop gdpPercap
##   &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;     &lt;int&gt;     &lt;dbl&gt;
## 1 China   Asia       1952    44   556263527      400.
## 2 China   Asia       1957    50.5 637408000      576.
## 3 China   Asia       1962    44.5 665770000      488.
## 4 China   Asia       1967    58.4 754550000      613.
```

---

# Summary

We've discussed a lot so far:

* Commenting (`mean(x) # take mean of x`)

--

* Saving/Loading files (`save()`, `load()`)

--

* Working Directories (`setwd()`, `getwd()`)

--

* Pipes (`gapminder %&gt;% filter(country == "Algeria")`)

--

* Logical Operators (`!=`, `==`, `&gt;`, `&lt;=` )

--

* Combining Logical Operators (AND using `&amp;`, OR using `|`)


With time and practice, these tools will become second nature!

---

# Test Your Knowledge

**Question 1: How could I filter the gapminder data to observations from Mexico after 1980?**

**Question 2: What's the mean life expectancy in Mexico after 1980, based on this dataset?**&lt;sup&gt;1&lt;/sup&gt;



*Take 1 minute to work on this problem by yourself, then talk through your ideas with your neighbor.*

.footnote[Hint: Save the result from the first question in one line of code, then write a second line of code to answer the second question.]


---

# My Solution

**Question 1: How could I filter the gapminder data to observations from Mexico after 1980?**


```r
Mexico1980 &lt;- gapminder %&gt;% filter(country == "Mexico" &amp; 
                                     year &gt;= 1980)
head(Mexico1980,2)
```

```
## # A tibble: 2 × 6
##   country continent  year lifeExp      pop gdpPercap
##   &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
## 1 Mexico  Americas   1982    67.4 71640904     9611.
## 2 Mexico  Americas   1987    69.5 80122492     8688.
```

--

**Question 2: What's the mean life expectancy in Mexico after 1980, based on this dataset?**


```r
Mexico1980$lifeExp %&gt;% mean()
```

```
## [1] 72.1875
```


---
class: inverse

# Visualizing Data w/ `ggplot2`


---

## Base R Plots from Last Week

.pull-left[
 .small[

```r
plot(lifeExp ~ year, 
     data = China, 
     xlab = "Year", 
     ylab = "Life expectancy",
     main = "Life expectancy in China", 
     col = "red", 
     cex.lab = 1.5,
     cex.main= 1.5,
     pch = 16)
```

 ]
 The plot is made with *one function* and *many arguments*
]

.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-20-1.png)&lt;!-- --&gt;
]

---
## Starter Example in `ggplot`


.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") +
  theme_bw(base_size=18)
```
  ]
  This `ggplot` is made with *many functions* and *fewer arguments* in each
]

.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-22-1.svg)&lt;!-- --&gt;
]

---
# `ggplot2`

An alternative way of plotting uses the `ggplot2` package in R, which is part of the `tidyverse`.



```r
library(ggplot2)
```

The core idea underlying this package is the [**layered grammar of graphics**](https://doi.org/10.1198/jcgs.2009.07098): we can break up elements of a plot into pieces and combine them.

--

`ggplot`s are a bit harder to create, but are usually: 

* prettier, 
* more professional, and
* more customizable!


---
# Structure of a ggplot

`ggplot2` graphics objects consist of two primary components:

--

1. **Layers**, the components of a graph.

   * We *add* layers to a `ggplot2` object using `+`.
   * This includes adding lines, shapes, and text to a plot.

--

2. **Aesthetics**, which determine how the layers appear.

   * We *set* aesthetics using *arguments* (e.g. `color="red"`) inside layer functions.
   * This includes modifying locations, colors, and sizes of the layers.

---

# Layers

**Layers** are the components of the graph, such as:

* `ggplot()`: initializes `ggplot2` object, specifies input data
* `geom_point()`: layer of scatterplot points
* `geom_line()`: layer of lines
* `ggtitle()`, `xlab()`, `ylab()`: layers of labels
* `facet_wrap()`: layer creating separate panels stratified by some factor wrapping around
* `facet_grid()`: same idea, but can split by two variables along rows and columns (e.g. `facet_grid(gender ~ age_group)`)
* `theme_bw()`: replace default gray background with black-and-white

Layers are separated by a `+` sign. For clarity, I usually put each layer on a new line.

---

# Aesthetics

**Aesthetics** control the appearance of the layers:

* `x`, `y`: `\(x\)` and `\(y\)` coordinate values to use
* `color`: set color of elements based on some data value, e.g., `color=red`, `color=continent`
* `group`: describe which points are conceptually grouped together for the plot (often used with lines)
* `size`: set size of points/lines based on some data value (greater than 0)
* `alpha`: set transparency based on some data value (between 0 and 1)


---
class: inverse

# Examples: Basic Jargon in Action!

We'll now build up two `ggplot`s together that demonstrate common layers and aesthetics.

---

## Axis Labels, Points, No Background

### 1: Base Plot

.pull-left[
 .small[

```r
*ggplot(data = China,
*      aes(x = year, y = lifeExp))
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-25-1.svg)&lt;!-- --&gt;
]

.footnote[Initialize the plot with `ggplot()` and `x` and `y` aesthetics **mapped** to variables. These aesthetics will be accesible to any future layers since they're in the primary layer.]

---


## Axis Labels, Points, No Background

### 2: Scatterplot

.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
* geom_point()
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-27-1.svg)&lt;!-- --&gt;
]

.footnote[Add a scatterplot **layer**.]
---


## Axis Labels, Points, No Background

### 3: Point Color and Size

.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
* geom_point(color = "red", size = 3)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-29-1.svg)&lt;!-- --&gt;
]

.footnote[**Set** aesthetics to make the points large and red.]
---


## Axis Labels, Points, No Background

### 4: X-Axis Label

.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
* xlab("Year")
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-31-1.svg)&lt;!-- --&gt;
]

.footnote[Add a layer to capitalize the x-axis label.]
---


## Axis Labels, Points, No Background

### 5: Y-Axis Label

.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
* ylab("Life expectancy")
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-33-1.svg)&lt;!-- --&gt;
]

.footnote[Add a layer to clean up the y-axis label.]
---


## Axis Labels, Points, No Background

### 6: Title

.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
* ggtitle("Life expectancy in China")
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-35-1.svg)&lt;!-- --&gt;
]

.footnote[Add a title layer.]
---


## Axis Labels, Points, No Background

### 7: Theme

.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") +
* theme_bw()
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-37-1.svg)&lt;!-- --&gt;
]

.footnote[Pick a nicer theme with a new layer.]
---


## Axis Labels, Points, No Background

### 8: Text Size

.pull-left[
 .small[

```r
ggplot(data = China, 
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy in China") +
* theme_bw(base_size=18)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-39-1.svg)&lt;!-- --&gt;
]

.footnote[Increase the base text size.]
---
# Plotting All Countries

We have a plot we like for China... 

... but what if we want *all the countries*?

---


# Plotting All Countries

### 1: A Mess!
.pull-left[
 .small[

```r
*ggplot(data = gapminder,
       aes(x = year, y = lifeExp)) +
  geom_point(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-41-1.svg)&lt;!-- --&gt;
]

.footnote[We can't tell countries apart! Maybe we could follow *lines*?]

---


# Plotting All Countries

### 2: Lines
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp)) +
* geom_line(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-43-1.svg)&lt;!-- --&gt;
]

.footnote[`ggplot2` doesn't know how to connect the lines!]

---


# Plotting All Countries

### 3: Grouping
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
*          group = country)) +
  geom_line(color = "red", size = 3) +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-45-1.svg)&lt;!-- --&gt;
]

.footnote[That looks more reasonable... but the lines are too thick!]
---


# Plotting All Countries

### 4: Size
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country)) +
* geom_line(color = "red") +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-47-1.svg)&lt;!-- --&gt;
]

.footnote[Much better... but maybe we can do highlight regional differences?]

---


# Plotting All Countries

### 5: Color
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
*          color = continent)) +
* geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-49-1.svg)&lt;!-- --&gt;
]

.footnote[Patterns are obvious... but why not separate continents completely?]

---


# Plotting All Countries

### 6: Facets
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw(base_size=18) + 
* facet_wrap(~ continent)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-51-1.svg)&lt;!-- --&gt;
]

.footnote[Now the text is too big!]
---


# Plotting All Countries

### 7: Text Size
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
* theme_bw() +
  facet_wrap(~ continent)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-53-1.svg)&lt;!-- --&gt;
]

.footnote[Better, but could bring that legend in.]

---


# Plotting All Countries

### 8: Legend Position
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() +  
  facet_wrap(~ continent) +
* theme(legend.position = c(0.8, 0.25))
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-55-1.svg)&lt;!-- --&gt;
]

.footnote[Better... but do we even need it?]
---


# Plotting All Countries

### 9: No Legend
.pull-left[
 .small[

```r
ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() +  
  facet_wrap(~ continent) +
* theme(legend.position = "none")
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-57-1.svg)&lt;!-- --&gt;
]

.footnote[Looking good!]


---
class: inverse

# More Advanced Functionalities

Next, we'll discuss:

* Storing and saving plots

* Advanced axis changes (scales, text, ticks)

* *Legendary* legend changes (scales, colors, locations)

---

# Storing Plots

We can assign a `ggplot` object to a name:


```r
lifeExp_by_year &lt;- 
  ggplot(data = gapminder, 
       aes(x = year, y = lifeExp, 
           group = country, 
           color = continent)) +
  geom_line() +
  xlab("Year") + 
  ylab("Life expectancy") +
  ggtitle("Life expectancy over time") +
  theme_bw() + 
  facet_wrap(~ continent) +
  theme(legend.position = "none")
```

The graph won't be displayed when you do this. You can show the graph using a single line of code with just the object name, *or take the object and add more layers*.

---

# Showing a Stored Graph


```r
lifeExp_by_year
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-59-1.svg)&lt;!-- --&gt;

---

# Adding a Layer


```r
lifeExp_by_year +
    theme(legend.position = "bottom")
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-60-1.svg)&lt;!-- --&gt;


---

# Saving `ggplot` Plots

When you knit an R Markdown file, any plots you make are automatically saved in the "figure" folder in `.png` format. If you want to save another copy (perhaps of a different file type for use in a manuscript), use `ggsave()`:


```r
ggsave("I_saved_a_file.pdf", plot = lifeExp_by_year,
       height = 3, width = 5, units = "in")
```

If you didn't manually set font sizes, these will usually come out at a reasonable size given the dimensions of your output file.

**Bad/non-reproducible way**&lt;sup&gt;1&lt;/sup&gt;: choose *Export* on the plot preview or take a screenshot / snip.

.footnote[[1] I still do this for quick emails of simple plots. Bad me!]

---

# Changing the Axes

We can modify the axes in a variety of ways, such as:

* Change the `\(x\)` or `\(y\)` range using `xlim()` or `ylim()` layers

* Change to a logarithmic or square-root scale on either axis: `scale_x_log10()`, `scale_y_sqrt()`

* Change where the major/minor breaks are: `scale_x_continuous(breaks =, minor_breaks = )`

---

# Axis Changes


```r
ggplot(data = China, aes(x = year, y = gdpPercap)) +
    geom_line() +
*   scale_y_log10(breaks = c(1000, 2000, 3000, 4000, 5000),
*                 labels = scales::dollar) +
    xlim(1940, 2010) + ggtitle("Chinese GDP per capita")
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-62-1.svg)&lt;!-- --&gt;

---

# Fonts Too Small?


```r
ggplot(data = China, aes(x = year, y = lifeExp)) +
    geom_line() +
    ggtitle("Chinese life expectancy") +
*   theme_gray(base_size = 20)
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-63-1.svg)&lt;!-- --&gt;

---

# Text and Tick Adjustments

Text size, labels, tick marks, etc. can be messed with more precisely using arguments to the `theme()` layer. 

--

Examples:

* `plot.title = element_text(size = rel(2), hjust = 0)` makes the title twice as big as usual and left-aligns it
* `axis.text.x = element_text(angle = 45)` rotates `\(x\)` axis labels
* `axis.text = element_text(colour = "blue")` makes the `\(x\)` and `\(y\)` axis labels blue
* `axis.ticks.length = unit(.5, "cm")` makes the axis ticks longer

--

Note: `theme()` is a different layer than `theme_gray()` or `theme_bw()`, which you might also be using in a previous layer. See the [`ggplot2` documentation](http://docs.ggplot2.org/current/theme.html) for details. 

I recommend using `theme()` *after* `theme_bw()` or other *global themes*.

---

# Scales for Color, Shape, etc.

**Scales** are layers that control how the mapped aesthetics appear. 

You can modify these with a `scale_[aesthetic]_[option]()` layer:

* `[aesthetic]` is `color`, `shape`, `linetype`, `alpha`, `size`, `fill`, etc.

* `[option]` is something like `manual`, `continuous` or `discrete` (depending on nature of the variable).

--

**Examples:**

* `scale_linetype_manual()`: manually specify the linetype for each different value
* `scale_alpha_continuous()`: varies transparency over a continuous range
* `scale_color_brewer(palette = "Spectral")`: uses a palette from &lt;http://colorbrewer2.org&gt; (great site for picking nice plot colors!)

---

## Legend Name and Manual Colors
.small[

```r
lifeExp_by_year +
  theme(legend.position = c(0.8, 0.2)) +
  scale_color_manual(
*   name = "Which continent are\nwe looking at?", # \n adds a line break
    values = c("Africa" = "seagreen", "Americas" = "turquoise1", 
               "Asia" = "royalblue", "Europe" = "violetred1", "Oceania" = "yellow"))
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-64-1.svg)&lt;!-- --&gt;
]

---
class: inverse

# Advanced Example!


---

## End Result

We're going to *slowly* build up a *really detailed plot* now!

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-65-1.svg)&lt;!-- --&gt;


---
## 1. Base Plot
.smaller[

```r
*ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country))
  #
  #
  #  
  #
  #
  #
  #
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-66-1.svg)&lt;!-- --&gt;
]

---


## 2. Lines

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
* geom_line()
  #
  #  
  #
  #
  #
  #
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-67-1.svg)&lt;!-- --&gt;
]
---


## 3. Continent Average

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line() +
* geom_line(stat = "smooth", method = "loess",
*           aes(group = continent))
  #
  #
  #
  #
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-68-1.svg)&lt;!-- --&gt;
]

.footnote[Note: A [*loess* curve](https://en.wikipedia.org/wiki/Local_regression) is something like a moving average.]
---


## 4. Facets

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line() +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent)) +
* facet_wrap(~ continent, nrow = 2)
  #
  #
  #
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-69-1.svg)&lt;!-- --&gt;
]

---


## 5. Color Scale

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
* geom_line(aes(color = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
*           aes(group = continent, color = "Continent")) +
  facet_wrap(~ continent, nrow = 2) +
* scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue"))
  #
  #
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-70-1.svg)&lt;!-- --&gt;
]
---


## 6. Size Scale
.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
* geom_line(aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
*           aes(group = continent, color = "Continent", size = "Continent")) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
* scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3))
  #
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-71-1.svg)&lt;!-- --&gt;
]
---


## 7. Alpha (Transparency)

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
* geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
*           aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3))
  #
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-72-1.svg)&lt;!-- --&gt;
]

---


## 8. Theme and Labels

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
* theme_minimal(base_size = 14) + ylab("Years") + xlab("")
  #
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-73-1.svg)&lt;!-- --&gt;
]
---


## 9. Title and Subtitle

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
  theme_minimal(base_size = 14) + ylab("Years") + xlab("") + 
* ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country")
  #
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-74-1.svg)&lt;!-- --&gt;
]
---


## 10. Angled Tick Values

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
  theme_minimal(base_size = 14) + ylab("Years") + xlab("") + 
  ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country") +
* theme(axis.text.x = element_text(angle = 45))
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-75-1.svg)&lt;!-- --&gt;
]

.footnote[Note: Fewer values might be better than angled labels!]
---


## 11. Legend Position

.smaller[

```r
ggplot(data = gapminder, aes(x = year, y = lifeExp, group = country)) +
  geom_line(alpha = 0.5, aes(color = "Country", size = "Country")) +
  geom_line(stat = "smooth", method = "loess", 
            aes(group = continent, color = "Continent", size = "Continent"), alpha = 0.5) +
  facet_wrap(~ continent, nrow = 2) +
  scale_color_manual(name = "Life Exp. for:", values = c("Country" = "black", "Continent" = "blue")) +
  scale_size_manual(name = "Life Exp. for:", values = c("Country" = 0.25, "Continent" = 3)) +
  theme_minimal(base_size = 14) + ylab("Years") + xlab("") + 
  ggtitle("Life Expectancy, 1952-2007", subtitle = "By continent and country") +
* theme(legend.position=c(0.82, 0.15), axis.text.x = element_text(angle = 45))
```

![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-76-1.svg)&lt;!-- --&gt;
]
---



## Summary

`ggplot2` can do a LOT! I won't expect you to remember all these tools.

  
.pull-left[
.small[
* With time and practice, you'll start to remember the key tools

* When in doubt, Google it! ("*R ggplot rename title*")

* There are lots of great resources out there:

  + The [Cookbook for R website](http://www.cookbook-r.com/Graphs/Legends_%28ggplot2%29)
  
  + The [RStudio ggplot Cheatsheets](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf).
  
  + Kieran Healy's book [Data Visualization: A Practical Introduction](https://socviz.co/) (right) which is targeted at social scientists without technical backgrounds.
]
]
.pull-right[
&lt;img src="img/dv-cover-pupress.jpg" width="90%"/&gt;
]

---
class: inverse

# Exercise: Histograms

In pairs, you will create a histogram of life expectancy observations in the complete Gapminder dataset.

1. Set the base layer by specifying the data as `gapminder` and the x variable as `lifeExp`

2. Add a second layer to create a histogram using the function `geom_histogram()`

3. Customize your plot with nice axis labels and a title. 

---

# My Solution

### 1: Set Base Layer
.pull-left[
 .small[

```r
ggplot(gapminder,aes(x=lifeExp))
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-78-1.svg)&lt;!-- --&gt;
]


---

# My Solution

### 2: Add Histogram Layer
.pull-left[
 .small[

```r
ggplot(gapminder,aes(x=lifeExp))+
  geom_histogram(bins=30)
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-80-1.svg)&lt;!-- --&gt;
]

.footnote[Setting the `bins` argument removes a pesky message!]

---

# My Solution

### 3: Add Aesthetics
.pull-left[
 .small[

```r
ggplot(gapminder,aes(x=lifeExp))+
  geom_histogram(bins=30)+
  xlab("Life Expectancy")+
  ylab("Count")+
  ggtitle("Histogram of Life Expectancy 
          in Gapminder Data")
```
]
]
.pull-right[
![](CSSS508_Lecture2_ggplot2_files/figure-html/unnamed-chunk-82-1.svg)&lt;!-- --&gt;
]

---
class: inverse

# Homework 2

Pick some relationship to look at in the Gapminder data and write up a .Rmd file investigating that question graphically. You might work with a subset of the data (e.g. just Africa). Upload both the `.Rmd` file and the `.html` file to Canvas. 

* Include 4 to 8 plots.
* All titles, axes, and legends should be labelled clearly (no raw variable names).
* You must have at least one graph with `facet_wrap()` or `facet_grid()`.
* You must include at least one manually specified legend.
* You can use other `geoms` like histograms, bar charts, add vertical or horizontal lines, etc.

Your document should be pleasant for a peer to look at, with some organization. You must write up your observations in words as well as showing the graphs. Use chunk options like `echo=FALSE` to limit the code/output you show in the `.html`.
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "tomorrow-night-bright",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
